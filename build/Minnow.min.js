/*! Minnow 2015-06-10 */
angular.module("App",["ui.router","ngSanitize"]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,b){b.when("/note","/note/:id"),a.state("index",{url:"/",templateUrl:"templates/main.html"}).state("login",{url:"/",templateUrl:"templates/login.html",controller:"LoginCtrl"}).state("editor",{url:"/note/:id",templateUrl:"templates/editor.html",controller:"EditorCtrl"}),b.otherwise("/")}]).run(["$rootScope","$state","$location",function(a,b){a.$on("$locationChangeStart",function(a){Parse.User.current()||(a.preventDefault(),b.go("login"))})}]),angular.module("App").controller("EditorCtrl",["$scope","$state","NoteService","UserService",function(a,b,c,d){c.buildModel(b.params.id,function(b){a.note=b,a.$apply()}),a.back=function(){clearInterval(e),d.saveNote(a.note),c.save(a.note,function(){a.note=null}),b.go("index")};var e;!function(){var b=angular.copy(a.note);e=setInterval(function(){JSON.stringify(b)!==JSON.stringify(a.note)&&(d.saveNote(a.note),c.save(a.note,function(){})),b=angular.copy(a.note)},5e3)}()}]),angular.module("App").controller("ViewNotebookCtrl",["$scope","$state","NotebookService",function(a){a.params=$stateParams}]),angular.module("App").controller("LoginCtrl",["$scope","$state","UserService",function(a,b,c){a.login=function(){Parse.FacebookUtils.logIn(null,"pass").then(function(a){a.existed()?c.buildModel(a,function(){b.go("index")}):c.newUser(a,function(a){c.buildModel(a,function(){b.go("index")})})})}}]),angular.module("App").controller("MainCtrl",["$scope","$state","UserService","NoteService",function(a,b,c,d){a.searchString="",a.newNote=function(){d.newNote(function(a){b.go("editor",{id:a})})},a.deleteNote=function(a,b){c.deleteNote(a,b,function(){})},a.logout=function(){b.go("login"),a.user=null,c.logout(function(){})},a.$watch(function(){return c.model?c.model.notes.length:void 0},function(){Parse.User.current()&&!a.user&&c.buildModel(Parse.User.current(),function(){a.user=c.model,a.$apply()})},!0)}]),angular.module("App").directive("contenteditable",["$sce",function(a){return{restrict:"A",require:"?ngModel",scope:{selected:"="},link:function(b,c,d,e){function f(){var a=c.html();d.stripBr&&"<br>"==a&&(a=""),e.$setViewValue(a)}e&&(e.$render=function(){c.html(a.getTrustedHtml(e.$viewValue||"<p><br></p>"))},c.on("blur keyup change",function(){b.$evalAsync(f)}),c.on("click",function(a){angular.element(a.target)}),c.on("keyup",function(){angular.element(window.getSelection().anchorNode).parent();if(13==event.keyCode){angular.element(window.getSelection().anchorNode)}}),c.on("keydown",function(){return 13==event.keyCode?void document.execCommand("formatBlock",!1,"p"):8==event.keyCode&&c.text()<1?void event.preventDefault():void 0}),c.on("keypress",function(){}),f())}}}]),angular.module("App").directive("mediumEditor",function(){return{require:"ngModel",restrict:"AE",scope:{bindOptions:"="},link:function(a,b,c,d){angular.element(b).addClass("angular-medium-editor");var e={},f="",g=function(){c.options&&(e=a.$eval(c.options));var b={};void 0!==a.bindOptions&&(b=a.bindOptions),e=angular.extend(e,b)};g(),f=e.placeholder,a.$watch("bindOptions",function(){d.editor&&d.editor.destroy(),g(),d.$isEmpty(d.$viewValue)||(e.placeholder=""),d.editor=new MediumEditor(b,e)});var h=function(){a.$apply(function(){if("<p><br></p>"===b.html()||""===b.html()){e.placeholder=f;{new MediumEditor(b,e)}}d.$setViewValue(b.html())})};b.on("blur",h),b.on("input",h),d.$render=function(){this.editor||(d.$isEmpty(d.$viewValue)||(e.placeholder=""),this.editor=new MediumEditor(b,e)),b.html(d.$isEmpty(d.$viewValue)?"":d.$viewValue),d.$isEmpty(d.$viewValue)||angular.element(b).removeClass("medium-editor-placeholder")}}}}),angular.module("App").factory("NoteService",function(){var a={};return a.model=null,a.newNote=function(b){var c=Parse.Object.extend("Note"),d=new c;d.set("parent",Parse.User.current()),d.set("title",""),d.set("body",""),d.save().then(function(c){a.model={},a.model.title="",a.model.body="",b(c.id)})},a.buildModel=function(b,c){var d=new Parse.Query("Note");d.get(b).then(function(b){b.get("parent").id!==Parse.User.current().id&&console.error("Note does not belong to current user"),a.model={title:b.get("title"),body:b.get("body"),id:b.id},c(a.model)})},a.save=function(a,b){var c=a.title,d=a.body,e=new Parse.Query("Note");e.get(a.id).then(function(a){a.set("title",c),a.set("body",d),a.save().then(function(a){b(a)})})},a}),angular.module("App").factory("NotebookService",function(){var a={};return a}),angular.module("App").factory("UserService",function(){var a={},b=function(a){return a};return a.newUser=function(a,b){FB.api("/me",function(c){c&&!c.error&&(a.set("name",c.first_name),a.save().then(function(){b(a)}))})},a.model=null,a.buildModel=function(c,d){var e=new Parse.Query("Note");e.equalTo("parent",c),e.find().then(function(e){a.model={},a.model.name=c.get("name"),a.model.id=c.id,a.model.notes=[],angular.forEach(e,function(c){var d={title:c.get("title"),body:c.get("body"),id:c.id};d.snippet=b(d.body).substring(0,25),a.model.notes.push(d)}),d(a.model)})},a.logout=function(b){FB.getLoginStatus(function(c){c&&"connected"===c.status&&FB.logout(function(){Parse.User.logOut(),a.model=null,b()})})},a.saveNote=function(c){var d=-1;angular.forEach(a.model.notes,function(a,b){c.id==a.id&&(d=b)}),d>-1?(c.snippet=c.body.substring(0,25),a.model.notes[d]=c):(c.snippet=b(c.body).substring(0,25),a.model.notes.push(c))},a.deleteNote=function(b,c){c>-1&&a.model.notes.splice(c,1);var d=new Parse.Query("Note");d.get(b.id).then(function(a){a.destroy()})},a});