/*! Minnow 2015-07-08 */
angular.module("App",["ui.router","textAngular","ngAnimate"]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,b){b.when("/note","/note/:id"),a.state("index",{url:"/",templateUrl:"templates/main.html"}).state("login",{url:"/",templateUrl:"templates/login.html",controller:"LoginCtrl"}).state("editor",{url:"/note/:id",templateUrl:"templates/editor.html",controller:"EditorCtrl"}),b.otherwise("/")}]).run(["$rootScope","$state","$location",function(a,b){a.$on("$locationChangeStart",function(a){Parse.User.current()||(a.preventDefault(),b.go("login"))})}]),angular.module("App").controller("EditorCtrl",["$scope","$state","NoteService","UserService",function(a,b,c,d){a.isLoading=!0,c.buildModel(b.params.id,function(b){a.note=b,a.isLoading=!1}),a.back=function(){clearInterval(e),d.saveNote(a.note),c.save(a.note,function(){a.note=null}),b.go("index")};var e;!function(){var b=angular.copy(a.note);e=setInterval(function(){JSON.stringify(b)!==JSON.stringify(a.note)&&(d.saveNote(a.note),c.save(a.note,function(){})),b=angular.copy(a.note)},1e4)}()}]),angular.module("App").controller("LoginCtrl",["$scope","$state","UserService",function(a,b,c){a.login=function(){Parse.FacebookUtils.logIn(null,"pass").then(function(a){a.existed()?c.buildModel(a,function(){b.go("index")}):c.newUser(a,function(a){c.buildModel(a,function(){b.go("index")})})})}}]),angular.module("App").controller("MainCtrl",["$scope","$state","UserService","NoteService",function(a,b,c,d){a.isLoading=!0,a.searchString="",a.notebook=d.notebook,a.notebookName={name:""},a.notebookTally=function(b){if(a.user){if("all"===b)return a.user.notes.length;for(var c=0,d=0;d<a.user.notes.length;d++)a.user.notes[d].notebook===b&&c++;return c}},a.openNote=function(a,c){b.go("editor",{id:c}),d.setModel(a)},a.newNote=function(){d.newNote(function(a){b.go("editor",{id:a})})},a.openNotebook=function(b){b||(b={title:""}),d.notebook=b,a.notebook=b},a.newNotebook=function(b){a.notebookName.name="",a.user.notebooks.push({title:b}),a.notebook={title:b},d.newNotebook(b,function(){})},a.deleteNote=function(a,b){c.deleteNote(a,b,function(){})},a.deleteNotebook=function(b,d){b.title==a.notebook.title&&(a.notebook={title:""}),a.user.notebooks.splice(d,1),c.deleteNotebook(b,d)},a.logout=function(){b.go("login"),a.user=null,c.logout(function(){})},a.$watch(function(){return c.model?c.model.notes.length:void 0},function(){Parse.User.current()&&!a.user&&c.buildModel(Parse.User.current(),function(){a.user=c.model,a.isLoading=!1,a.$apply()})},!0)}]),angular.module("App").directive("falseTyping",[function(){return{restrict:"A",link:function(a,b){function c(){setInterval(function(){var a=f.css("opacity");a&&"0"!==a?f.css("opacity",0):f.css("opacity",1)},600)}var d=b.html();b.html("");var e=angular.element(b.append("<span id='false-body'></span>").children()[[0]]),f=angular.element(b.append("<span id='false-bar'>|</span>").children()[[1]]),g=0,h=setInterval(function(){var a=d.slice(0,g);e.html(a),a===d&&(clearInterval(h),c()),g++},75)}}}]),angular.module("App").directive("mediumEditor",function(){return{require:"ngModel",restrict:"AE",scope:{bindOptions:"="},link:function(a,b,c,d){angular.element(b).addClass("angular-medium-editor");var e={},f="",g=function(){c.options&&(e=a.$eval(c.options));var b={};void 0!==a.bindOptions&&(b=a.bindOptions),e=angular.extend(e,b),e.staticToolbar=!0,e.toolbarAlign="left"};g(),f=e.placeholder,a.$watch("bindOptions",function(){d.editor&&d.editor.destroy(),g(),d.$isEmpty(d.$viewValue)||(e.placeholder=""),d.editor=new MediumEditor(b,e)});var h=function(){a.$apply(function(){if("<p><br></p>"===b.html()||""===b.html()){e.placeholder=f;{new MediumEditor(b,e)}}d.$setViewValue(b.html())})};b.on("blur",h),b.on("input",h),d.$render=function(){this.editor||(d.$isEmpty(d.$viewValue)||(e.placeholder=""),this.editor=new MediumEditor(b,e)),b.html(d.$isEmpty(d.$viewValue)?"":d.$viewValue),d.$isEmpty(d.$viewValue)||angular.element(b).removeClass("medium-editor-placeholder")}}}}),angular.module("App").directive("notebook",function(){return{restrict:"E",priority:1001,scope:{notebook:"="},template:' <div ng-repeat="nbook in user.notebooks" ng-click="openNotebook(nbook)">{{nbook.title}}<span class="delete"><i class="material-icons icon">delete</i></span></div>',link:function(a,b){angular.element(b).on("mouseover",function(){console.log("LETS GO")})}}}),angular.module("App").directive("searchBar",function(){return{restrict:"E",template:'<span class="search"><input ng-model="searchString"></input><i class="material-icons search-icon">search</i></span>',link:function(a,b){var c=angular.element(b).children().children();angular.element(c[0]).on("click",function(){angular.element(c[1]).addClass("rotate"),setTimeout(function(){angular.element(c[1]).removeClass("rotate")},300)})}}}),angular.module("App").filter("searchFilter",function(){return function(a,b){if(b.body){var c=a.filter(function(a){return a.body.toLowerCase().indexOf(b.body.toLowerCase())>-1});return c}return a}}),angular.module("App").factory("NoteService",function(){var a={};return a.model=null,a.notebooks=[],a.notebook={title:""},a.setModel=function(b){a.model=b,console.log(a.model)},a.newNotebook=function(a,b){var c=Parse.Object.extend("Notebook"),d=new c;d.set("parent",Parse.User.current()),d.set("title",a),d.save().then(function(c){b({title:a,id:c.id})})},a.newNote=function(b){var c=Parse.Object.extend("Note"),d=new c;d.set("parent",Parse.User.current()),d.set("title",""),d.set("body",""),d.set("notebook",a.notebook.title),d.save().then(function(c){a.model={},a.model.title="Untitled",a.model.body="",a.model.notebook=a.notebook.title,b(c.id)})},a.buildModel=function(b,c){a.model&&c(a.model);var d=new Parse.Query("Note");d.get(b).then(function(b){b.get("parent").id!==Parse.User.current().id&&console.error("Note does not belong to current user"),a.model={title:b.get("title"),body:b.get("body"),notebook:b.get("notebook"),id:b.id},c(a.model)})},a.save=function(a,b){var c=a.title,d=a.body,e=new Parse.Query("Note");e.get(a.id).then(function(a){a.set("title",c),a.set("body",d),a.save().then(function(a){b(a)})})},a}),angular.module("App").factory("NotebookService",function(){var a={};return a}),angular.module("App").factory("UserService",function(){function a(a){var b=document.createElement("div");b.innerHTML=a;var c="";return angular.forEach(angular.element(b).children(),function(a){c+=" "+(a.textContent||a.innerText||"")}),c=c.replace(/\s\s+/g," "),c=c.substring(0,200)}var b={};return b.newUser=function(a,b){FB.api("/me",function(c){c&&!c.error&&(a.set("name",c.first_name),a.save().then(function(){b(a)}))})},b.model=null,b.buildModel=function(c,d){var e=new Parse.Query("Note");e.equalTo("parent",c),e.find().then(function(f){b.model={},b.model.name=c.get("name"),b.model.id=c.id,b.model.notes=[],b.model.notebooks=[],angular.forEach(f,function(c){var d={title:c.get("title"),body:c.get("body"),notebook:c.get("notebook"),id:c.id};d.snippet=a(d.body),b.model.notes.push(d)}),e=new Parse.Query("Notebook"),e.equalTo("parent",c),e.find().then(function(a){angular.forEach(a,function(a){b.model.notebooks.push({title:a.get("title"),id:a.id})}),d(b.model)})})},b.logout=function(a){FB.getLoginStatus(function(c){c&&"connected"===c.status&&FB.logout(function(){Parse.User.logOut(),b.model=null,a()})})},b.saveNote=function(c){c.snippet=a(c.body),console.log(c);var d=-1;angular.forEach(b.model.notes,function(a,b){c.id==a.id&&(d=b)}),d>-1?b.model.notes[d]=c:b.model.notes.push(c)},b.deleteNote=function(a,c){c>-1&&b.model.notes.splice(c,1);var d=new Parse.Query("Note");d.get(a.id).then(function(a){a.destroy()})},b.deleteNotebook=function(a,c){c>-1&&b.model.notebooks.splice(c,1);var d=new Parse.Query("Notebook");d.get(a.id).then(function(a){a.destroy()})},b});